<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    background-color: black;
}
html, body {
    overflow: hidden;
}
body {
  background: black;
}
</style>
</head>

<body onload="startGame()">

<img src="pic/ships/ship1a.png" id="ship1a" style="display: none;">
<img src="pic/ships/ship1b.png" id="ship1b" style="display: none;">
<img src="pic/ships/ship1c.png" id="ship1c" style="display: none;">
<img src="pic/ships/ship1d.png" id="ship1d" style="display: none;">
<img src="pic/ships/ship1e.png" id="ship1e" style="display: none;">

<img src="pic/texture/water.jpg" id="water" style="display: none;">
<img src="pic/texture/water2.jpg" id="water2" style="display: none;">

<img src="pic/exp/ex1.png" id="ex1" style="display: none;">
<img src="pic/exp/ex2.png" id="ex2" style="display: none;">
<img src="pic/exp/ex3.png" id="ex3" style="display: none;">
<img src="pic/exp/ex4.png" id="ex4" style="display: none;">
<img src="pic/exp/ex5.png" id="ex5" style="display: none;">
<img src="pic/exp/ex6.png" id="ex6" style="display: none;">
<img src="pic/exp/ex7.png" id="ex7" style="display: none;">
<img src="pic/exp/ex8.png" id="ex8" style="display: none;">
<img src="pic/exp/ex9.png" id="ex9" style="display: none;">
<img src="pic/exp/ex10.png" id="ex10" style="display: none;">
<img src="pic/exp/ex11.png" id="ex11" style="display: none;">
<img src="pic/exp/ex12.png" id="ex12" style="display: none;">
<img src="pic/exp/ex13.png" id="ex13" style="display: none;">
<img src="pic/exp/ex14.png" id="ex14" style="display: none;">
<img src="pic/exp/ex15.png" id="ex15" style="display: none;">
<img src="pic/exp/ex16.png" id="ex16" style="display: none;">
<img src="pic/exp/ex17.png" id="ex17" style="display: none;">
<img src="pic/exp/ex18.png" id="ex18" style="display: none;">
<img src="pic/exp/ex19.png" id="ex19" style="display: none;">
<img src="pic/exp/ex20.png" id="ex20" style="display: none;">
<img src="pic/exp/ex21.png" id="ex21" style="display: none;">
<img src="pic/exp/ex22.png" id="ex22" style="display: none;">
<img src="pic/exp/ex23.png" id="ex23" style="display: none;">
<img src="pic/exp/ex24.png" id="ex24" style="display: none;">
<img src="pic/exp/ex25.png" id="ex25" style="display: none;">
<img src="pic/exp/ex26.png" id="ex26" style="display: none;">
<img src="pic/exp/ex27.png" id="ex27" style="display: none;">
<img src="pic/exp/ex28.png" id="ex28" style="display: none;">
<img src="pic/exp/ex29.png" id="ex29" style="display: none;">
<img src="pic/exp/ex30.png" id="ex30" style="display: none;">
<img src="pic/exp/ex31.png" id="ex31" style="display: none;">
<img src="pic/exp/ex32.png" id="ex32" style="display: none;">
<img src="pic/exp/ex33.png" id="ex33" style="display: none;">
<img src="pic/exp/ex34.png" id="ex34" style="display: none;">
<img src="pic/exp/ex35.png" id="ex35" style="display: none;">
<img src="pic/exp/ex36.png" id="ex36" style="display: none;">
<img src="pic/exp/ex37.png" id="ex37" style="display: none;">
<img src="pic/exp/ex38.png" id="ex38" style="display: none;">
<img src="pic/exp/ex39.png" id="ex39" style="display: none;">
<img src="pic/exp/ex40.png" id="ex40" style="display: none;">
<img src="pic/exp/ex41.png" id="ex41" style="display: none;">
<img src="pic/exp/ex42.png" id="ex42" style="display: none;">
<img src="pic/exp/ex43.png" id="ex43" style="display: none;">
<img src="pic/exp/ex44.png" id="ex44" style="display: none;">
<img src="pic/exp/ex45.png" id="ex45" style="display: none;">
<img src="pic/exp/ex46.png" id="ex46" style="display: none;">
<img src="pic/exp/ex47.png" id="ex47" style="display: none;">
<img src="pic/exp/ex48.png" id="ex48" style="display: none;">
<img src="pic/exp/ex49.png" id="ex49" style="display: none;">
<img src="pic/exp/ex50.png" id="ex50" style="display: none;">
<img src="pic/exp/ex51.png" id="ex51" style="display: none;">
<img src="pic/exp/ex52.png" id="ex52" style="display: none;">
<img src="pic/exp/ex53.png" id="ex53" style="display: none;">
<img src="pic/exp/ex54.png" id="ex54" style="display: none;">
<img src="pic/exp/ex55.png" id="ex55" style="display: none;">
<img src="pic/exp/ex56.png" id="ex56" style="display: none;">
<img src="pic/exp/ex57.png" id="ex57" style="display: none;">
<img src="pic/exp/ex58.png" id="ex58" style="display: none;">
<img src="pic/exp/ex59.png" id="ex59" style="display: none;">
<img src="pic/exp/ex60.png" id="ex60" style="display: none;">
<img src="pic/exp/ex61.png" id="ex61" style="display: none;">
<img src="pic/exp/ex62.png" id="ex62" style="display: none;">
<img src="pic/exp/ex63.png" id="ex63" style="display: none;">
<img src="pic/exp/ex64.png" id="ex64" style="display: none;">

<img src="pic/hit/hit1.png" id="hit1" style="display: none;">
<img src="pic/hit/hit2.png" id="hit2" style="display: none;">
<img src="pic/hit/hit3.png" id="hit3" style="display: none;">
<img src="pic/hit/hit4.png" id="hit4" style="display: none;">
<img src="pic/hit/hit5.png" id="hit5" style="display: none;">
<img src="pic/hit/hit6.png" id="hit6" style="display: none;">
<img src="pic/hit/hit7.png" id="hit7" style="display: none;">
<img src="pic/hit/hit8.png" id="hit8" style="display: none;">
<img src="pic/hit/hit9.png" id="hit9" style="display: none;">
<img src="pic/hit/hit10.png" id="hit10" style="display: none;">

<img src="pic/hit/hit11.png" id="hit11" style="display: none;">
<img src="pic/hit/hit12.png" id="hit12" style="display: none;">
<img src="pic/hit/hit13.png" id="hit13" style="display: none;">
<img src="pic/hit/hit14.png" id="hit14" style="display: none;">
<img src="pic/hit/hit15.png" id="hit15" style="display: none;">
<img src="pic/hit/hit16.png" id="hit16" style="display: none;">
<img src="pic/hit/hit17.png" id="hit17" style="display: none;">
<img src="pic/hit/hit18.png" id="hit18" style="display: none;">
<img src="pic/hit/hit19.png" id="hit19" style="display: none;">
<img src="pic/hit/hit20.png" id="hit20" style="display: none;">

<img src="pic/hit/hit21.png" id="hit21" style="display: none;">
<img src="pic/hit/hit22.png" id="hit22" style="display: none;">
<img src="pic/hit/hit23.png" id="hit23" style="display: none;">
<img src="pic/hit/hit24.png" id="hit24" style="display: none;">
<img src="pic/hit/hit25.png" id="hit25" style="display: none;">
<img src="pic/hit/hit26.png" id="hit26" style="display: none;">
<img src="pic/hit/hit27.png" id="hit27" style="display: none;">
<img src="pic/hit/hit28.png" id="hit28" style="display: none;">
<img src="pic/hit/hit29.png" id="hit29" style="display: none;">
<img src="pic/hit/hit30.png" id="hit30" style="display: none;">

<img src="pic/hit/hit31.png" id="hit31" style="display: none;">
<img src="pic/hit/hit32.png" id="hit32" style="display: none;">
<img src="pic/hit/hit33.png" id="hit33" style="display: none;">
<img src="pic/hit/hit34.png" id="hit34" style="display: none;">
<img src="pic/hit/hit35.png" id="hit35" style="display: none;">
<img src="pic/hit/hit36.png" id="hit36" style="display: none;">
<img src="pic/hit/hit37.png" id="hit37" style="display: none;">
<img src="pic/hit/hit38.png" id="hit38" style="display: none;">
<img src="pic/hit/hit39.png" id="hit39" style="display: none;">
<img src="pic/hit/hit40.png" id="hit40" style="display: none;">

<img src="pic/hit/hit41.png" id="hit41" style="display: none;">
<img src="pic/hit/hit42.png" id="hit42" style="display: none;">
<img src="pic/hit/hit43.png" id="hit43" style="display: none;">
<img src="pic/hit/hit44.png" id="hit44" style="display: none;">
<img src="pic/hit/hit45.png" id="hit45" style="display: none;">
<img src="pic/hit/hit46.png" id="hit46" style="display: none;">
<img src="pic/hit/hit47.png" id="hit47" style="display: none;">
<img src="pic/hit/hit48.png" id="hit48" style="display: none;">


<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script>

//var person = prompt("Please enter your name");
var person = "ship";

var numberOfPlayers=4;

var socket = io();

var tempId=100;
var myGamePiece = new myShip(Math.floor(Math.random()*1025), Math.floor(Math.random()*1025),
person, tempId);

var otherShips=new Array();
var balls=new Array();
var exps=new Array();
var hits=new Array();

// ships data
var receivedShip1;
var receivedShip2;
var receivedShip3;
var receivedShip4;

// balls data
var receivedBall1;
var receivedBall2;
var receivedBall3;
var receivedBall4;

// fist id variable to recognise user that asks server for id
var firstId=Math.floor(Math.random()*1000000);

// instructions
var insTime=300;

// node js connection to data from server
// setting id
socket.on('setId', function(msg1){
  if(msg1.firstId==firstId){
    if(msg1.status!=tempId){
      tempId=msg1.status;
      myGamePiece=new myShip(Math.floor(Math.random()*1025), Math.floor(Math.random()*1025),
      person, tempId);
    }
  }
});

// asking for id interval function
function askId() {
setInterval(function(){
    if(myGamePiece.id==100){
      var msg1={"firstId":firstId,"status":tempId};
      socket.emit('setId', msg1);
    }
}, 10); // to fix
}

askId();

// ships sockets
socket.on('id1', function(ship1){
  receivedShip1=ship1;
});
socket.on('id2', function(ship2){
  receivedShip2=ship2;
});
socket.on('id3', function(ship3){
  receivedShip3=ship3;
});
socket.on('id4', function(ship4){
  receivedShip4=ship4;
});

// creating balls
// ship1
socket.on('data1', function(ball1){
  receivedBall1=ball1;
});
// ship2
socket.on('data2', function(ball2){
  receivedBall2=ball2;
});
// ship3
socket.on('data3', function(ball3){
  receivedBall3=ball3;
});
// ship4
socket.on('data4', function(ball4){
  receivedBall4=ball4;
});


// rounding numbers function
function round(n, k){
    var factor = Math.pow(10, k);
    return Math.round(n*factor)/factor;
}


// interval for data receiving
function dataR1() {
setInterval(function(){

  // receiving positions

  // ship1
  if(receivedShip1!=null&&receivedShip1.id!=myGamePiece.id){
    // checking if the ship is allready on the map
    var newPiece=true;
    for(var x=0; x<otherShips.length; x++){
      if(otherShips[x].id==receivedShip1.id){
        otherShips[x].update(receivedShip1.x, receivedShip1.y, receivedShip1.a, receivedShip1.hp);
        newPiece=false;
      }
    }
    if(newPiece){
      otherShips.push(new otherShip(receivedShip1.x, receivedShip1.y,
      receivedShip1.a, receivedShip1.id, receivedShip1.n, receivedShip1.hp));
    }
    receivedShip1=null;
  }

  // ship2
  if(receivedShip2!=null&&receivedShip2.id!=myGamePiece.id){
    // checking if the ship is allready on the map
    var newPiece=true;
    for(var x=0; x<otherShips.length; x++){
      if(otherShips[x].id==receivedShip2.id){
        otherShips[x].update(receivedShip2.x, receivedShip2.y, receivedShip2.a, receivedShip2.hp);
        newPiece=false;
      }
    }
    if(newPiece){
      otherShips.push(new otherShip(receivedShip2.x, receivedShip2.y,
      receivedShip2.a, receivedShip2.id, receivedShip2.n, receivedShip2.hp));
    }
    receivedShip2=null;
  }

  // ship3
  if(receivedShip3!=null&&receivedShip3.id!=myGamePiece.id){
    // checking if the ship is allready on the map
    var newPiece=true;
    for(var x=0; x<otherShips.length; x++){
      if(otherShips[x].id==receivedShip3.id){
        otherShips[x].update(receivedShip3.x, receivedShip3.y, receivedShip3.a, receivedShip3.hp);
        newPiece=false;
      }
    }
    if(newPiece){
      otherShips.push(new otherShip(receivedShip3.x, receivedShip3.y,
      receivedShip3.a, receivedShip3.id, receivedShip3.n, receivedShip3.hp));
    }
    receivedShip3=null;
  }

  // ship4
  if(receivedShip4!=null&&receivedShip4.id!=myGamePiece.id){
    // checking if the ship is allready on the map
    var newPiece=true;
    for(var x=0; x<otherShips.length; x++){
      if(otherShips[x].id==receivedShip4.id){
        otherShips[x].update(receivedShip4.x, receivedShip4.y, receivedShip4.a, receivedShip4.hp);
        newPiece=false;
      }
    }
    if(newPiece){
      otherShips.push(new otherShip(receivedShip4.x, receivedShip4.y,
      receivedShip4.a, receivedShip4.id, receivedShip4.n, receivedShip4.hp));
    }
    receivedShip4=null;
  }


  // receiving balls
  if(receivedBall1!=null){
    balls.push(new ball(receivedBall1.x, receivedBall1.y, receivedBall1.a, 1));
    exps.push(new exp(receivedBall1.x, receivedBall1.y, receivedBall1.a));
    receivedBall1=null;
  }
  if(receivedBall2!=null){
    balls.push(new ball(receivedBall2.x, receivedBall2.y, receivedBall2.a, 2));
    exps.push(new exp(receivedBall2.x, receivedBall2.y, receivedBall2.a));
    receivedBall2=null;
  }
  if(receivedBall3!=null){
    balls.push(new ball(receivedBall3.x, receivedBall3.y, receivedBall3.a, 3));
    exps.push(new exp(receivedBall3.x, receivedBall3.y, receivedBall3.a));
    receivedBall3=null;
  }
  if(receivedBall4!=null){
    balls.push(new ball(receivedBall4.x, receivedBall4.y, receivedBall4.a, 4));
    exps.push(new exp(receivedBall4.x, receivedBall4.y, receivedBall4.a));
    receivedBall4=null;
  }

}, 10);
}

// interval for data sending
function dataS1() {
setInterval(function(){

  // sending your position
  if(myGamePiece.id==1){
    var ship1={"id":myGamePiece.id,"x":round(myGamePiece.x, 0),"y":round(myGamePiece.y, 0),
    "a":round(myGamePiece.angle, 4),"n":myGamePiece.name,"hp":myGamePiece.hp};
    socket.emit('id1', ship1);
  }
  if(myGamePiece.id==2){
    var ship2={"id":myGamePiece.id,"x":round(myGamePiece.x, 0),"y":round(myGamePiece.y, 0),
    "a":round(myGamePiece.angle, 4),"n":myGamePiece.name,"hp":myGamePiece.hp};
    socket.emit('id2', ship2);
  }
  if(myGamePiece.id==3){
    var ship3={"id":myGamePiece.id,"x":round(myGamePiece.x, 0),"y":round(myGamePiece.y, 0),
    "a":round(myGamePiece.angle, 4),"n":myGamePiece.name,"hp":myGamePiece.hp};
    socket.emit('id3', ship3);
  }
  if(myGamePiece.id==4){
    var ship4={"id":myGamePiece.id,"x":round(myGamePiece.x, 0),"y":round(myGamePiece.y, 0),
    "a":round(myGamePiece.angle, 4),"n":myGamePiece.name,"hp":myGamePiece.hp};
    socket.emit('id4', ship4);
  }

}, 100);
}

// running functions to send data
dataS1();

// running function to collect data
dataR1();


///////////////////////////////////// MAIN CANVAS INTERVAL FUNCTION
function updateGameArea() {

    myGameArea.clear();

    var ctx = myGameArea.context;
    ctx.drawImage(water, window.innerWidth/2-myGamePiece.x, window.innerHeight/2-myGamePiece.y);

    // showing other ships
    if(otherShips.length>0){
      for(var x=0; x<otherShips.length; x++){
          otherShips[x].show();
          if(otherShips[x].timer<=0){
            otherShips.splice(x,1);
          }
      }
    }

    // showing user ship
    myGamePiece.update();

    // showing balls
    if(balls.length>0){
      for(var x=0; x<balls.length; x++){
          balls[x].show();
      }
    }
    // deleting balls when timer is zero
    if(balls.length>0){
      for(var x=0; x<balls.length; x++){
          if(balls[x].timer<=0){
            balls.splice(x,1);
          }
      }
    }

    // showing explosions
    if(exps.length>0){
      for(var x=0; x<exps.length; x++){
          exps[x].show();
      }
    }
    // deleting explosions when timer is zero
    if(exps.length>0){
      for(var x=0; x<exps.length; x++){
          if(exps[x].exLoop>64){
            exps.splice(x,1);
          }
      }
    }

    // showing hits
    if(hits.length>0){
      for(var x=0; x<hits.length; x++){
          hits[x].show();
      }
    }
    // deleting hits when timer is zero
    if(hits.length>0){
      for(var x=0; x<hits.length; x++){
          if(hits[x].exLoop>48){
            hits.splice(x,1);
          }
      }
    }



    // checking if player was hit
/*
    ctx = myGameArea.context;
    ctx.fillStyle = "red";

    ctx.fillRect(-15+window.innerWidth/2, -15+window.innerHeight/2, 30, 30);

    ctx.fillRect(-15 + window.innerWidth/2+round((-30 * Math.sin(myGamePiece.angle)), 0),
      -15 + window.innerHeight/2+round((30 * Math.cos(myGamePiece.angle)), 0),30,30);

    ctx.fillRect(-15 + window.innerWidth/2+round((30 * Math.sin(myGamePiece.angle)), 0),
      -15 + window.innerHeight/2+round((-30 * Math.cos(myGamePiece.angle)), 0),30,30);
*/

    // checking 3 squares
    if(balls.length>0&&myGamePiece.inGame){
      for(var x=0; x<balls.length; x++){
          if(Math.abs(balls[x].x-myGamePiece.x)<15 && Math.abs(balls[x].y-myGamePiece.y)<15
          &&balls[x].id!=myGamePiece.id){
            myGamePiece.hp-=3;
            hits.push(new hit(balls[x].x, balls[x].y, balls[x].a));
            balls.splice(x,1);
          }
          if(Math.abs(balls[x].x-(myGamePiece.x-15+round((-30 * Math.sin(myGamePiece.angle)), 0)))<15
           && Math.abs(balls[x].y-(myGamePiece.y-15+round((30 * Math.cos(myGamePiece.angle)), 0)))<15
          &&balls[x].id!=myGamePiece.id){
            myGamePiece.hp-=3;
            hits.push(new hit(balls[x].x, balls[x].y, balls[x].a));
            balls.splice(x,1);
          }

          if(Math.abs(balls[x].x-(myGamePiece.x-15+round((30 * Math.sin(myGamePiece.angle)), 0)))<15
           && Math.abs(balls[x].y-(myGamePiece.y-15+round((-30 * Math.cos(myGamePiece.angle)), 0)))<15
          &&balls[x].id!=myGamePiece.id){
            myGamePiece.hp-=3;
            hits.push(new hit(balls[x].x, balls[x].y, balls[x].a));
            balls.splice(x,1);
          }
      }
    }

    // checking if other ship was hit
    // checking 3 squares
    if(balls.length>0&&otherShips.length>0){
      for(var z=0; z<otherShips.length; z++){
        for(var x=0; x<balls.length; x++){
          if(Math.abs(balls[x].x-(otherShips[z].x))<15
          && Math.abs(balls[x].y-(otherShips[z].y))<15
          &&balls[x].id!=otherShips[z].id){
            hits.push(new hit(balls[x].x, balls[x].y, balls[x].a));
            balls.splice(x,1);
          }
          if(Math.abs(balls[x].x-(otherShips[z].x-15+round((-30 * Math.sin(otherShips[z].angle)), 0)))<15
          && Math.abs(balls[x].y-(otherShips[z].y-15+round((30 * Math.cos(otherShips[z].angle)), 0)))<15
          &&balls[x].id!=otherShips[z].id){
            hits.push(new hit(balls[x].x, balls[x].y, balls[x].a));
            balls.splice(x,1);
          }
          if(Math.abs(balls[x].x-(otherShips[z].x-15+round((30 * Math.sin(otherShips[z].angle)), 0)))<15
          && Math.abs(balls[x].y-(otherShips[z].y-15+round((-30 * Math.cos(otherShips[z].angle)), 0)))<15
          &&balls[x].id!=otherShips[z].id){
            hits.push(new hit(balls[x].x, balls[x].y, balls[x].a));
            balls.splice(x,1);
          }
        }
      }
    }

    // ships collision detection
    if(otherShips.length>0){
      for(var z=0; z<otherShips.length; z++){

          // first square
          if(Math.abs(myGamePiece.x-(otherShips[z].x))<20
          && Math.abs(myGamePiece.y-(otherShips[z].y))<20
          ){
            myGamePiece.hp--;
          }
          if(Math.abs(myGamePiece.x-(otherShips[z].x-15+round((-30 * Math.sin(otherShips[z].angle)), 0)))<20
          && Math.abs(myGamePiece.y-(otherShips[z].y-15+round((30 * Math.cos(otherShips[z].angle)), 0)))<20
          ){
            myGamePiece.hp--;
          }
          if(Math.abs(myGamePiece.x-(otherShips[z].x-15+round((30 * Math.sin(otherShips[z].angle)), 0)))<20
          && Math.abs(myGamePiece.y-(otherShips[z].y-15+round((-30 * Math.cos(otherShips[z].angle)), 0)))<20
          ){
            myGamePiece.hp--;
          }

          // second square
          if(Math.abs((myGamePiece.x-15+round((-30 * Math.sin(myGamePiece.angle)), 0))-(otherShips[z].x))<20
          && Math.abs((myGamePiece.y-15+round((30 * Math.cos(myGamePiece.angle)), 0))-(otherShips[z].y))<20
          ){
            myGamePiece.hp--;
          }
          if(Math.abs((myGamePiece.x-15+round((-30 * Math.sin(myGamePiece.angle)), 0))
          -(otherShips[z].x-15+round((-30 * Math.sin(otherShips[z].angle)), 0)))<20
          && Math.abs((myGamePiece.y-15+round((30 * Math.cos(myGamePiece.angle)), 0))
          -(otherShips[z].y-15+round((30 * Math.cos(otherShips[z].angle)), 0)))<20
          ){
            myGamePiece.hp--;
          }
          if(Math.abs((myGamePiece.x-15+round((-30 * Math.sin(myGamePiece.angle)), 0))
          -(otherShips[z].x-15+round((30 * Math.sin(otherShips[z].angle)), 0)))<20
          && Math.abs((myGamePiece.y-15+round((30 * Math.cos(myGamePiece.angle)), 0))
          -(otherShips[z].y-15+round((-30 * Math.cos(otherShips[z].angle)), 0)))<20
          ){
            myGamePiece.hp--;
          }

          // third square
          if(Math.abs((myGamePiece.x-15+round((30 * Math.sin(myGamePiece.angle)), 0))-(otherShips[z].x))<20
          && Math.abs((myGamePiece.y-15+round((-30 * Math.cos(myGamePiece.angle)), 0))-(otherShips[z].y))<20
          ){
            myGamePiece.hp--;
          }
          if(Math.abs((myGamePiece.x-15+round((30 * Math.sin(myGamePiece.angle)), 0))-(otherShips[z].x-15+round((-30 * Math.sin(otherShips[z].angle)), 0)))<20
          && Math.abs((myGamePiece.y-15+round((-30 * Math.cos(myGamePiece.angle)), 0))-(otherShips[z].y-15+round((30 * Math.cos(otherShips[z].angle)), 0)))<20
          ){
            myGamePiece.hp--;
          }
          if(Math.abs((myGamePiece.x-15+round((30 * Math.sin(myGamePiece.angle)), 0))-(otherShips[z].x-15+round((30 * Math.sin(otherShips[z].angle)), 0)))<20
          && Math.abs((myGamePiece.y-15+round((-30 * Math.cos(myGamePiece.angle)), 0))-(otherShips[z].y-15+round((-30 * Math.cos(otherShips[z].angle)), 0)))<20
          ){
            myGamePiece.hp--;
          }

      }
    }


    // checking if player died
    if(myGamePiece.hp<=0){
      myGamePiece = new myShip(Math.floor(Math.random()*1025), Math.floor(Math.random()*1025), person, tempId);
    }



}/////////////////////////////////////////////////// end of game update



















function myShip( x, y, name, id) {

    this.id=id;
    this.name=name;
    this.hp=100;
    this.inGame=false;

    this.speed = 0;
    this.angle = 0;
    this.moveAngle = 0;

    this.x = x;
    this.y = y;

    // shooting
    this.timerS=0;
    this.shot;
    this.shootBoth=false;

    this.leftAmmo=10;
    this.rightAmmo=10;
    this.leftLoad=100;
    this.rightLoad=100;

    this.scale=0.3;


    this.update = function() {

        // for 4 ships only
        if(this.id!=100){
          this.inGame=true;
        }else{
          this.inGame=false;
        }

        this.speed = 0;
        this.moveAngle = 0;

        // shooting and sending data
        if(this.inGame){
        // if in game

        // shooting both sides
        if(myGameArea.keys && myGameArea.keys[79] && this.timerS==0){

          if(this.shootBoth && this.rightAmmo>0){
            this.shootBoth=false;
            this.rightAmmo--;
            var shootingHole=Math.floor(Math.random()*5);
            if(shootingHole==0){
              this.shot={"x":round(this.x+(20 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
              "y":round(this.y-(20 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
            }else if(shootingHole==1){
              this.shot={"x":round(this.x+(12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
              "y":round(this.y-(12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
            }else if(shootingHole==2){
              this.shot={"x":round(this.x+(4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
              "y":round(this.y-(4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
            }else if(shootingHole==3){
              this.shot={"x":round(this.x+(-4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
              "y":round(this.y-(-4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
            }else if(shootingHole==4){
              this.shot={"x":round(this.x+(-12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
              "y":round(this.y-(-12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
            }

            this.timerS=10;

            if(this.id==1){
              socket.emit('data1', this.shot);
            }
            if(this.id==2){
              socket.emit('data2', this.shot);
            }
            if(this.id==3){
              socket.emit('data3', this.shot);
            }
            if(this.id==4){
              socket.emit('data4', this.shot);
            }

          }else if(!this.shootBoth && this.leftAmmo>0){
            this.shootBoth=true;
            this.leftAmmo--;
            var shootingHole=Math.floor(Math.random()*5);
            if(shootingHole==0){
              this.shot={"x":round(this.x+(20 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
              "y":round(this.y-(20 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
            }else if(shootingHole==1){
              this.shot={"x":round(this.x+(12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
              "y":round(this.y-(12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
            }else if(shootingHole==2){
              this.shot={"x":round(this.x+(4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
              "y":round(this.y-(4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
            }else if(shootingHole==3){
              this.shot={"x":round(this.x+(-4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
              "y":round(this.y-(-4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
            }else if(shootingHole==4){
              this.shot={"x":round(this.x+(-12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
              "y":round(this.y-(-12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
              "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
            }

            this.timerS=10;

            if(this.id==1){
              socket.emit('data1', this.shot);
            }
            if(this.id==2){
              socket.emit('data2', this.shot);
            }
            if(this.id==3){
              socket.emit('data3', this.shot);
            }
            if(this.id==4){
              socket.emit('data4', this.shot);
            }

          }

        }

        // shooting right side
        if(myGameArea.keys && myGameArea.keys[80] && this.timerS==0 && this.rightAmmo>0){
          this.rightAmmo--;
          var shootingHole=Math.floor(Math.random()*5);
          if(shootingHole==0){
            this.shot={"x":round(this.x+(20 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
            "y":round(this.y-(20 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
          }else if(shootingHole==1){
            this.shot={"x":round(this.x+(12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
            "y":round(this.y-(12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
          }else if(shootingHole==2){
            this.shot={"x":round(this.x+(4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
            "y":round(this.y-(4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
          }else if(shootingHole==3){
            this.shot={"x":round(this.x+(-4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
            "y":round(this.y-(-4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
          }else if(shootingHole==4){
            this.shot={"x":round(this.x+(-12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle+90 * Math.PI / 180)), 0),
            "y":round(this.y-(-12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle+90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  + 90) * Math.PI / 180), 4)};
          }

          this.timerS=10;

          if(this.id==1){
            socket.emit('data1', this.shot);
          }
          if(this.id==2){
            socket.emit('data2', this.shot);
          }
          if(this.id==3){
            socket.emit('data3', this.shot);
          }
          if(this.id==4){
            socket.emit('data4', this.shot);
          }
        }

        // shooting left side
        if(myGameArea.keys && myGameArea.keys[73] && this.timerS==0 && this.leftAmmo>0){
          this.leftAmmo--;
          var shootingHole=Math.floor(Math.random()*5);
          if(shootingHole==0){
            this.shot={"x":round(this.x+(20 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
            "y":round(this.y-(20 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
          }else if(shootingHole==1){
            this.shot={"x":round(this.x+(12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
            "y":round(this.y-(12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
          }else if(shootingHole==2){
            this.shot={"x":round(this.x+(4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
            "y":round(this.y-(4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
          }else if(shootingHole==3){
            this.shot={"x":round(this.x+(-4 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
            "y":round(this.y-(-4 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
          }else if(shootingHole==4){
            this.shot={"x":round(this.x+(-12 * Math.sin(this.angle))+ 12 * (Math.sin(this.angle-90 * Math.PI / 180)), 0),
            "y":round(this.y-(-12 * Math.cos(this.angle))- 12 * (Math.cos(this.angle-90 * Math.PI / 180)), 0),
            "a":round(this.angle+( (Math.round(Math.random() * (20)) - 10  - 90) * Math.PI / 180), 4)};
          }

          this.timerS=10;

          if(this.id==1){
            socket.emit('data1', this.shot);
          }
          if(this.id==2){
            socket.emit('data2', this.shot);
          }
          if(this.id==3){
            socket.emit('data3', this.shot);
          }
          if(this.id==4){
            socket.emit('data4', this.shot);
          }
        }

        // loading guns
        if(this.leftAmmo<10){
          this.leftLoad--;
          if(this.leftLoad==0){
            this.leftAmmo++;
            this.leftLoad=100;
          }
        }

        if(this.rightAmmo<10){
          this.rightLoad--;
          if(this.rightLoad==0){
            this.rightAmmo++;
            this.rightLoad=100;
          }
        }

        }// if in game

        if(this.timerS>0){
          this.timerS--;
        }

        if(this.inGame){
        // if in game
        if(myGameArea.keys && myGameArea.keys[87]){
          this.speed= -1;
        }
        /*
        if(myGameArea.keys && myGameArea.keys[83]){
          this.speed= 1;
        }
        */
        if(myGameArea.keys && myGameArea.keys[65] ){
          this.moveAngle = -1;
        }
        if(myGameArea.keys && myGameArea.keys[68] ){
          this.moveAngle = 1;
        }

        } // if in game

        // moving as spectator
        if(this.id==100){
          if(myGameArea.keys && myGameArea.keys[87]){
            this.y-=3;
          }
          if(myGameArea.keys && myGameArea.keys[83]){
            this.y+=3;
          }
          if(myGameArea.keys && myGameArea.keys[65] ){
            this.x-=3;
          }
          if(myGameArea.keys && myGameArea.keys[68] ){
            this.x+=3;
          }
        }

        // map border detection
        if(myGamePiece.x<0){
          myGamePiece.x=0;
        }
        if(myGamePiece.x>1024){
          myGamePiece.x=1024;
        }
        if(myGamePiece.y<0){
          myGamePiece.y=0;
        }
        if(myGamePiece.y>1024){
          myGamePiece.y=1024;
        }

        if(this.inGame){

        // changing position
        this.angle += this.moveAngle * Math.PI / 180;
        this.x -= this.speed * Math.sin(this.angle);
        this.y += this.speed * Math.cos(this.angle);

        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(window.innerWidth/2, window.innerHeight/2);
        ctx.rotate(this.angle);

        // drawing the ship image
        if(this.hp>80){
          ctx.drawImage(ship1a, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
        }else if(this.hp>60){
          ctx.drawImage(ship1b, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
        }else if(this.hp>40){
          ctx.drawImage(ship1c, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
        }else if(this.hp>20){
          ctx.drawImage(ship1d, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
        }else if(this.hp>0){
          ctx.drawImage(ship1e, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
        }

        //ctx.fillStyle = "red";
        //ctx.fillRect(30 / -2, 60 / -2, 30, 60);
        ctx.restore();

        ctx.font = "bold 18px Courier New";
        ctx.fillStyle = "white";
        ctx.fillText("HP:"+this.hp,window.innerWidth/2-30,window.innerHeight/2-90);
        ctx.fillText(this.name,window.innerWidth/2-30,window.innerHeight/2-120);
        ctx.fillText("ID:"+this.id,window.innerWidth/2-30,window.innerHeight/2-150);
        ctx.font = "bold 15px Courier New";

        ctx.save();
        ctx.translate(window.innerWidth/2,window.innerHeight/2);
        ctx.rotate(this.angle);

        ctx.save();
        ctx.translate(-60,0);
        ctx.rotate(-this.angle);
        ctx.fillText("I"+this.leftAmmo,0,0);
        ctx.restore();

        ctx.save();
        ctx.translate(60,0);
        ctx.rotate(-this.angle);
        ctx.fillText("P"+this.rightAmmo,0,0);
        ctx.restore();

        ctx.restore();

        // instructions
        if(insTime>0){
          insTime--;
          ctx.font = "bold 20px Courier New";
          ctx.fillStyle = "red";
          ctx.fillText("MOVE : WAD  SHOOT: IOP",window.innerWidth/2-130,window.innerHeight-200);
        }

        }


        if(!this.inGame){
          var info = "Waiting to enter the game";
          if(this.id==100){
            ctx = myGameArea.context;
            ctx.font = "bold 30px Courier New";
            ctx.fillStyle = "red";
            ctx.fillText(info,window.innerWidth/2-200,window.innerHeight/2-100);
          }


        }

    }
}





function otherShip( x, y, a, id, name, hp) {

    this.id=id;
    this.name=name;
    this.hp=hp;

    this.angle = a;
    this.moveAngle = 0;

    this.x = x;
    this.y = y;
    this.targetX=x;
    this.targetY=y;

    this.prevX=x;
    this.prevY=y;
    this.prevX2=x;
    this.prevY2=y;
    this.moveTimer=0;
    this.onMove=false;

    this.scale=0.3;

    // time before object will be removed
    this.timer=150;


    this.update = function(newX, newY, newA, newHp) {

      this.targetX = newX;
      this.targetY = newY;
      this.targetA = newA;
      this.hp=newHp;

      // if the ship is far away from its target move it directly
      if(Math.abs(newX-this.x)>50||Math.abs(newY-this.y)>50){
        this.x = newX;
        this.y = newY;
      }

      // if ship angle is very different to target angle for more then 0.5 radian change it directly
      if(Math.abs(newA-this.angle)>0.5){
        this.angle = newA;
      }

        this.timer=150;
    }


    this.show = function() {

      // way of detecting move
      if(this.moveTimer<10){
        this.moveTimer++;
      }else{
        this.moveTimer=0;
        this.prevX2=this.prevX;
        this.prevY2=this.prevY;
      }
      this.prevX=this.x;
      this.prevY=this.y;

      if(this.targetX>this.x){
        this.x+=1;
      }
      if(this.targetX<this.x){
        this.x-=1;
      }
      if(this.targetY>this.y){
        this.y+=1;
      }
      if(this.targetY<this.y){
        this.y-=1;
      }

      // checking if ship is on move
      if(this.x!=this.prevX2||this.y!=this.prevY2){
        this.onMove=true;
      }else{
        this.onMove=false;
      }

      if(this.targetA>this.angle){
        this.moveAngle=1;
      }
      if(this.targetA<this.angle){
        this.moveAngle=-1;
      }
      if(Math.abs(this.targetA-this.angle)<0.05){
        this.moveAngle=0;
      }


      this.angle += this.moveAngle * Math.PI / 180;

      ctx = myGameArea.context;
      ctx.save();
      ctx.translate(window.innerWidth/2-myGamePiece.x+this.x,window.innerHeight/2-myGamePiece.y+this.y);
      ctx.rotate(this.angle);

      // drawing the ship image
      if(this.hp>80){
        ctx.drawImage(ship1a, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
      }else if(this.hp>60){
        ctx.drawImage(ship1b, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
      }else if(this.hp>40){
        ctx.drawImage(ship1c, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
      }else if(this.hp>20){
        ctx.drawImage(ship1d, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
      }else if(this.hp>0){
        ctx.drawImage(ship1e, -100*this.scale, -250*this.scale -13 , 200*this.scale, 500*this.scale);
      }

      //ctx.fillStyle = "blue";
      //ctx.fillRect(30 / -2, 60 / -2, 30, 60);
      ctx.restore();

      ctx.font = "bold 18px Courier New";
      ctx.fillStyle = "white";
      ctx.fillText("HP:"+this.hp,window.innerWidth/2-myGamePiece.x+this.x-30,window.innerHeight/2-myGamePiece.y+this.y-50);
      ctx.fillText(this.name,window.innerWidth/2-myGamePiece.x+this.x-30,window.innerHeight/2-myGamePiece.y+this.y-80);
      ctx.fillText("ID:"+this.id,window.innerWidth/2-myGamePiece.x+this.x-30,window.innerHeight/2-myGamePiece.y+this.y-110);

      this.timer--;

    }
}


function ball( x, y, a, id) {

    this.id=id;
    this.speed = 5;
    //this.speed = 0;
    this.angle = a;
    this.timer=60
    this.x = x;
    this.y = y;


    this.show = function() {

      this.x += this.speed * Math.sin(this.angle);
      this.y -= this.speed * Math.cos(this.angle);

      ctx = myGameArea.context;
      ctx.save();
      ctx.translate(window.innerWidth/2-myGamePiece.x+this.x,window.innerHeight/2-myGamePiece.y+this.y);
      ctx.rotate(this.angle);
      ctx.beginPath();

      ctx.fillStyle = "black";
      //ctx.fillStyle = "red";

      ctx.arc(0, 0, 2, 0, 2*Math.PI);
      ctx.closePath();
      ctx.fill();
      ctx.restore();


      this.timer--;

    }
}




function exp( x, y, a) {

    this.angle = a;
    this.x = x;
    this.y = y;
    this.delayTime=0;
    this.exLoop=1;
    this.scale=0.6;

    this.show = function() {

      ctx = myGameArea.context;
      ctx.save();
      ctx.translate(window.innerWidth/2-myGamePiece.x+this.x,window.innerHeight/2-myGamePiece.y+this.y);
      ctx.rotate(this.angle);
      this.delayTime++;
      if(this.exLoop<65){
        ctx.drawImage(document.getElementById("ex"+this.exLoop), -64*this.scale+37*this.scale, -128*this.scale+9*this.scale,
        128*this.scale/2, 128*this.scale);
        if(this.delayTime==1){
          this.exLoop+=2;
          this.delayTime=0;
        }
      }
      ctx.restore();


      this.timer--;

    }
}



function hit( x, y, a) {

    this.angle = a;
    this.x = x;
    this.y = y;
    this.delayTime=0;
    this.exLoop=1;
    this.scale=0.1;

    this.show = function() {

      ctx = myGameArea.context;
      ctx.save();
      ctx.translate(window.innerWidth/2-myGamePiece.x+this.x,window.innerHeight/2-myGamePiece.y+this.y);
      ctx.rotate(this.angle);
      this.delayTime++;
      if(this.exLoop<49){
        ctx.drawImage(document.getElementById("hit"+this.exLoop), -128*this.scale, -128*this.scale,
        256*this.scale, 256*this.scale);
        if(this.delayTime==1){
          this.exLoop+=2;
          this.delayTime=0;
        }
      }
      ctx.restore();


      this.timer--;

    }
}













//// MAIN GAME INTERVAL FUNCTION FOR CANVAS

function startGame() {
    myGameArea.start();
}


var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            myGameArea.keys = (myGameArea.keys || []);
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
    },
    stop : function() {
        clearInterval(this.interval);
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}




</script>

</body>
</html>
